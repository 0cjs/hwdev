#!/usr/bin/env bash
set -Eeuo pipefail
trap 'ec=$?; echo 1>&2 "INTERNAL ERROR: ec=$ec line=$LINENO cmd=$BASH_COMMAND";
      exit $ec;' ERR

die()  { ec="$1"; shift; echo 1>&2 "ERROR ($ec):" "$@"; exit $ec; }
fail() { ec=$?; echo "FAILED exitcode=$ec ($(elapsed)s)"; exit $ec; }

elapsed_start=$(date +%s)
elapsed() { echo $(( $(date +%s) - $elapsed_start )); }

####################################################################

export REPO=$(cd "$(dirname "$0")" && pwd -P)
cd "$REPO"

#   `render` doesn't need this, be we need it for running design checks.
kicad-cli --version >/dev/null 2>&1 || die 3 "kicad-cli command not found"
kicad-cli --version >kicad-version

#   XXX We do not yet always render everyting because `render` doesn't know
#   not to update the files that will be committed if only the creation
#   date has changed.
#./render */kicad/*.kicad_{sch,pcb}
echo "WARNING: not rendering; this must be done manually for changed files"

echo "OK ($(elapsed)s)"
